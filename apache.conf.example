# Configuration Apache pour Miss Excellence
# À placer dans /etc/apache2/sites-available/missexcellence.conf
# Activer avec : sudo a2ensite missexcellence.conf

# Site public - www.missexcellence.org (ou missexcellence.org)
<VirtualHost *:80>
    ServerName www.missexcellence.org
    ServerAlias missexcellence.org
    DocumentRoot /var/www/missexcellence/frontend/dist

    # Activation des modules nécessaires
    # sudo a2enmod proxy proxy_http rewrite headers

    # Proxy pour l'API backend
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api

    # Proxy pour les fichiers statiques du backend (images uploads, etc.)
    ProxyPass /static http://localhost:3000/static
    ProxyPassReverse /static http://localhost:3000/static

    # Servir les fichiers statiques du frontend
    <Directory /var/www/missexcellence/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Réécriture pour le routing React (fallback vers index.html)
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Headers pour le cache des assets statiques
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>

    # Compression Gzip
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/missexcellence_error.log
    CustomLog ${APACHE_LOG_DIR}/missexcellence_access.log combined
</VirtualHost>

# Site admin - admin.missexcellence.org
<VirtualHost *:80>
    ServerName admin.missexcellence.org
    DocumentRoot /var/www/missexcellence/frontend/dist

    # Proxy pour l'API backend
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api

    # Proxy pour les fichiers statiques du backend
    ProxyPass /static http://localhost:3000/static
    ProxyPassReverse /static http://localhost:3000/static

    # Servir les fichiers statiques du frontend
    <Directory /var/www/missexcellence/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Réécriture pour le routing React (fallback vers index.html)
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Headers pour le cache des assets statiques
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>

    # Compression Gzip
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/missexcellence_admin_error.log
    CustomLog ${APACHE_LOG_DIR}/missexcellence_admin_access.log combined
</VirtualHost>

# Configuration HTTPS (à décommenter après avoir configuré SSL avec Let's Encrypt)
# <VirtualHost *:443>
#     ServerName www.missexcellence.org
#     ServerAlias missexcellence.org
#     DocumentRoot /var/www/missexcellence/frontend/dist
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/missexcellence.org/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/missexcellence.org/privkey.pem
#
#     # Même configuration que le VirtualHost :80
#     ProxyPreserveHost On
#     ProxyPass /api http://localhost:3000/api
#     ProxyPassReverse /api http://localhost:3000/api
#     ProxyPass /static http://localhost:3000/static
#     ProxyPassReverse /static http://localhost:3000/static
#
#     <Directory /var/www/missexcellence/frontend/dist>
#         Options -Indexes +FollowSymLinks
#         AllowOverride All
#         Require all granted
#         RewriteEngine On
#         RewriteBase /
#         RewriteRule ^index\.html$ - [L]
#         RewriteCond %{REQUEST_FILENAME} !-f
#         RewriteCond %{REQUEST_FILENAME} !-d
#         RewriteRule . /index.html [L]
#     </Directory>
#
#     <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
#         ExpiresActive On
#         ExpiresDefault "access plus 1 year"
#         Header set Cache-Control "public, immutable"
#     </FilesMatch>
#
#     <IfModule mod_deflate.c>
#         AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
#     </IfModule>
#
#     ErrorLog ${APACHE_LOG_DIR}/missexcellence_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/missexcellence_ssl_access.log combined
# </VirtualHost>
#
# <VirtualHost *:443>
#     ServerName admin.missexcellence.org
#     DocumentRoot /var/www/missexcellence/frontend/dist
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/missexcellence.org/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/missexcellence.org/privkey.pem
#
#     # Même configuration que le VirtualHost :80
#     ProxyPreserveHost On
#     ProxyPass /api http://localhost:3000/api
#     ProxyPassReverse /api http://localhost:3000/api
#     ProxyPass /static http://localhost:3000/static
#     ProxyPassReverse /static http://localhost:3000/static
#
#     <Directory /var/www/missexcellence/frontend/dist>
#         Options -Indexes +FollowSymLinks
#         AllowOverride All
#         Require all granted
#         RewriteEngine On
#         RewriteBase /
#         RewriteRule ^index\.html$ - [L]
#         RewriteCond %{REQUEST_FILENAME} !-f
#         RewriteCond %{REQUEST_FILENAME} !-d
#         RewriteRule . /index.html [L]
#     </Directory>
#
#     <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
#         ExpiresActive On
#         ExpiresDefault "access plus 1 year"
#         Header set Cache-Control "public, immutable"
#     </FilesMatch>
#
#     <IfModule mod_deflate.c>
#         AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
#     </IfModule>
#
#     ErrorLog ${APACHE_LOG_DIR}/missexcellence_admin_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/missexcellence_admin_ssl_access.log combined
# </VirtualHost>
#
# # Redirection HTTP vers HTTPS
# <VirtualHost *:80>
#     ServerName www.missexcellence.org
#     ServerAlias missexcellence.org admin.missexcellence.org
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
# </VirtualHost>
